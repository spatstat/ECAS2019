---
title: "Notes for session 2"
author: "Adrian Baddeley and Ege Rubak"
date: "2019-07-02"
output: html
---

# Intensity

Often the main objective is to study
the "density" of points in the point pattern
and to investigate any spatial variation in this density.

## Definition

The observed _point pattern_ $x$ will be regarded as a realisation
of a random *point process* $X$.

The _intensity_ of the point process is the expected number of points
per unit area. It may be a constant $\lambda \ge 0$,
or it may be spatially varying.

We will usually assume that the point process has an
_intensity function_ $\lambda(u)$ defined at every spatial location $u$.
Then $\lambda(u)$ is the spatially-varying expected number of points
per unit area. It is formally defined to satisfy
$$ E[ n(B \cap X) ] = \int_B \lambda(u) \, {\rm d}u $$
for any region $B \subset R^2$, where $n(B \cap X) = $ number of points
falling in $B$.

Intensity is closely related to probability density.
If $X$ is a Poisson point process with intensity function $\lambda(u)$,
then each individual point inside $W$ has probability density
$f(u) = \lambda(u)/\Lambda_W$, where
$\Lambda_W = \int_W \lambda(u) \, {\rm d}u$.

## Nonparametric estimation

Because of the close relationship between intensity and
probability density, methods for nonparametric estimation of the intensity
function are very similar to methods for density estimation.

### Nonparametric estimation of spatially-varying intensity

EDITED UP TO HERE

```{r, fig.width=5, out.width='70%'}
library(spatstat)
X <- japanesepines
Z <- density(X)
Z <- density(X, bw.diggle)
plot(Z, main="")
```

### Nonparametric estimation of spatially-varying, mark-dependent intensity

```{r}
M <- split(mucosa)
B <- density(M, bw.diggle)
plot(B, main="")
```

The spatially-varying probability of each type
can be computed from the ratio of intensities:

```{r}
plot(B[["ECL"]]/(B[["ECL"]] + B[["other"]]))
```

```{r}
plot(relrisk(mucosa, casecontrol=FALSE))
```

### Nonparametric estimation of intensity depending on a covariate

```{r}
E <- split(mucosa)$ECL
g <- rhohat(E, "y")
plot(g)
```

```{r}
X <- murchison$gold
L <- murchison$faults
X <- rescale(X, 1000, "km")
L <- rescale(L, 1000, "km")
D <- distfun(L)
h <- rhohat(X, D)
plot(h)
```

## Parametric modelling

### Loglinear model for intensity

$$\log\lambda(u) = \beta_1 Z_1(u) + \ldots + \beta_p Z_p(u)$$

Explain about canonical variables vs original variables

### Fit using Poisson likelihood

```{r}
fit <- ppm(X ~ D)
coef(fit)
confint(fit)
anova(fit, test="Chi")
plot(effectfun(fit, "D"), xlim=c(0, 20))
plot(predict(fit))
```

```{r}
Jfit <- ppm(japanesepines ~ x + y)
Jfit
confint(Jfit)
Jfit2 <- ppm(japanesepines ~ polynom(x,y,2))
Jfit2
plot(predict(Jfit2))
```

```{r}
anova(Jfit, Jfit2, test="Chi")
```

```{r}
step(Jfit2)
```

```{r}
plot(simulate(Jfit2))
```

```{r}
plot(simulate(Jfit2, nsim=12))
```

### Intensity depends on marks

```{r}
model0 <- ppm(mucosa ~ marks)
model0
coef(model0)
plot(predict(model0), equal.ribbon=TRUE)
```

```{r}
model1 <- ppm(mucosa ~ marks + y)
model1
coef(model1)
plot(predict(model1))
```

```{r}
model2 <- ppm(mucosa ~ marks * y)
model2
coef(model2)
plot(predict(model2))
```

```{r}
model1xy <- ppm(mucosa ~ marks + x + y)
model1xy
coef(model1xy)
plot(predict(model1xy))
```

```{r}
model2xy <- ppm(mucosa ~ marks * (x + y))
model2xy
coef(model2xy)
plot(predict(model2xy))
```

```{r}
model3 <- ppm(mucosa ~ marks + polynom(x, y, 2))
model3
coef(model3)
plot(predict(model3))
```

```{r}
model4 <- ppm(mucosa ~ marks * polynom(x,y,2))
model4
coef(model4)
plot(predict(model4))
```

_relrisk.ppm_

```{r}
plot(relrisk(model4, casecontrol=FALSE))
```

```{r}
plot(relrisk(model3, casecontrol=FALSE), equal.ribbon=TRUE)
```
